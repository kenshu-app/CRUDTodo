<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRUDTodo</title>
    <style>
      .done {
        opacity: 0.3;
        text-decoration: line-through;
      }
      .edit {
        display: none;
      }
      .editing .edit {
        display: inline;
      }
      .error {
        color: #900;
        font-weight: bold;
        font-size: 0.8em;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>{{ state.title }}</h1>
      <input v-model="state.newMsg" @keyup.enter="addTodo" autofocus />
      <span class="error" v-if="state.error">{{ state.errorMessage }}</span>
      <ul>
        <li
          v-for="todo in state.todos"
          :class="{done: todo.completed, editing: todo === state.editObj}"
          :key="todo.id"
        >
          <input type="checkbox" v-model="todo.completed" />
          <label @dblclick="editTodo(todo)"> {{ todo.msg }} </label>&nbsp;
          <input
            class="edit"
            v-model="state.editMsg"
            @keyup.enter="updateTodo(todo)"
          />&nbsp;
          <button @click="deleteTodo(todo)">X</button>
        </li>
      </ul>
      <div v-if="existsTodo()">
        登録件数&nbsp;<strong>{{ todoCount() }}</strong>個
      </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
      Vue.createApp({
        setup() {
          const state = Vue.reactive({
            title: 'CRUD Todo',
            newMsg: '',
            todos: [],
            editObj: null,
            editMsg: '',
            error: false,
            errorMessage: '※ 値を入力してください',
          })
          Vue.onMounted(() => {
            getTodos()
          })
          const addTodo = () => {
            if (!state.newMsg) {
              state.error = true
              return
            }
            state.todos.push({
              id: new Date().getTime(),
              completed: false,
              msg: state.newMsg,
            })
            state.newMsg = ''
            state.error = false
            addTodos()
          }
          const editTodo = (todoObj) => {
            state.editObj = todoObj // 1件分のオブジェクトを代入
            state.editMsg = todoObj.msg // 1件分のタイトルを代入
          }
          const updateTodo = (todoObj) => {
            todoObj.msg = state.editMsg
            state.editObj = null
            state.editMsg = ''
            addTodos()
          }
          const deleteTodo = (todoObj) => {
            const delIndex = state.todos.indexOf(todoObj)
            state.todos.splice(delIndex, 1)
            addTodos()
          }
          const addTodos = () => {
            localStorage.setItem('todos', JSON.stringify(state.todos))
          }
          const getTodos = () => {
            const todos = localStorage.getItem('todos')
            if (todos) {
              state.todos = JSON.parse(todos)
            }
          }
          const existsTodo = () => {
            return state.todos.length > 0
          }
          const todoCount = () => {
            return state.todos.length.toString()
          }
          return {
            state,
            addTodo,
            editTodo,
            updateTodo,
            deleteTodo,
            existsTodo,
            todoCount,
          }
        },
      }).mount('#app')
    </script>
  </body>
</html>
